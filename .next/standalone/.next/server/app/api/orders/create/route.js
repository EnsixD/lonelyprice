"use strict";(()=>{var e={};e.id=426,e.ids=[426],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},28693:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>x,patchFetch:()=>v,requestAsyncStorage:()=>p,routeModule:()=>d,serverHooks:()=>m,staticGenerationAsyncStorage:()=>l});var s={};t.r(s),t.d(s,{POST:()=>u});var a=t(49303),i=t(88716),n=t(60670),o=t(19692),c=t(87070);async function u(e){try{let e=await (0,o.e)(),{data:{user:r},error:t}=await e.auth.getUser();if(t||!r)return c.NextResponse.json({success:!1,error:"Не авторизован"},{status:401});let{data:s,error:a}=await e.from("cart_items").select("*, services(*)").eq("user_id",r.id);if(a)return c.NextResponse.json({success:!1,error:"Ошибка загрузки корзины"},{status:500});if(!s||0===s.length)return c.NextResponse.json({success:!1,error:"Корзина пуста"},{status:400});let i=s.reduce((e,r)=>e+(r.services?.price||0)*r.quantity,0),{data:n,error:u}=await e.from("orders").insert({user_id:r.id,total_amount:i,status:"pending",payment_status:"unpaid"}).select().single();if(u)return c.NextResponse.json({success:!1,error:`Не удалось создать заказ: ${u.message}`,details:u},{status:500});let d=s.map(e=>({order_id:n.id,service_id:e.service_id,quantity:e.quantity,price:e.services?.price||0})),{error:p}=await e.from("order_items").insert(d),{error:l}=await e.from("messages").insert({order_id:n.id,sender_id:r.id,message:"Заказ создан. Ожидайте ответа администратора."}),{error:m}=await e.from("cart_items").delete().eq("user_id",r.id);return c.NextResponse.json({success:!0,orderId:n.id,redirectUrl:`/orders/${n.id}`})}catch(e){return c.NextResponse.json({success:!1,error:"Внутренняя ошибка сервера"},{status:500})}}let d=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/orders/create/route",pathname:"/api/orders/create",filename:"route",bundlePath:"app/api/orders/create/route"},resolvedPagePath:"/home/ensi/Projects/lonlyprice/app/api/orders/create/route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:p,staticGenerationAsyncStorage:l,serverHooks:m}=d,x="/api/orders/create/route";function v(){return(0,n.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:l})}},19692:(e,r,t)=>{t.d(r,{e:()=>i});var s=t(24746),a=t(71615);async function i(){let e=await (0,a.cookies)(),r="https://lvjmvxhppvssyhryjaal.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2am12eGhwcHZzc3locnlqYWFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3MDE2MzQsImV4cCI6MjA4MTI3NzYzNH0.xpHw8-n5DI1w0EZQz415rMn_Ejdr2GWxMzaz7ySIvB0";if(!r||!t)throw Error("Missing Supabase environment variables. Please create .env.local file with NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY");return(0,s.createServerClient)(r,t,{cookies:{getAll:()=>e.getAll(),setAll(r){try{r.forEach(({name:r,value:t,options:s})=>e.set(r,t,s))}catch{}}}})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[276,438,972],()=>t(28693));module.exports=s})();